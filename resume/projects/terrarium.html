<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Terrain Generator</title>

  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      overflow: hidden;
    }

    #world {
      width: 800px;
      height: 600px;
      border: 4px solid #c0c0c0;
      position: relative;
      background: linear-gradient(#87ceeb, #cfe9ff);
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }

    #ui {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.6);
      padding: 12px;
      border: 2px solid #444;
      font-family: sans-serif;
    }

    #ui button {
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      background: #222;
      color: #aaa;
      border: 2px solid #444;
    }

    #ui button.active {
      background: #444;
      color: #fff;
      border-color: #fff;
    }

    #ui label {
      color: #aaa;
      font-size: 13px;
    }

    #ui input[type="range"] {
      width: 140px;
    }
  </style>
</head>
<body>

  <div id="ui">
    <button id="spectateBtn">Spectate</button>
    <button id="destroyBtn">Destroy</button>
    <button id="createBtn">Create</button>

    <label>
      Brush Size: <span id="brushSizeLabel">1</span>
    </label>
    <input id="brushSize" type="range" min="1" max="10" step="1" value="1" />
  </div>

  <div id="world">
    <canvas id="worldCanvas" width="800" height="600"></canvas>
  </div>

  <script src="sky.js"></script>
  <script src="terrain.js"></script>
  <script src="water.js"></script>

  <script>
    const canvas = document.getElementById("worldCanvas");
    const ctx = canvas.getContext("2d");

    const sky = new Sky({ canvas, ctx });
    const terrain = new TerrainClass({ canvas, ctx, tileSize: 5 });
    terrain.generate();
    const water = new Water({ canvas, ctx, terrain });



    const spectateBtn = document.getElementById("spectateBtn");
    const destroyBtn  = document.getElementById("destroyBtn");
    const createBtn   = document.getElementById("createBtn");

    const brushSlider = document.getElementById("brushSize");
    const brushLabel  = document.getElementById("brushSizeLabel");

    let brushSize = Number(brushSlider.value);
    brushLabel.textContent = brushSize;

    brushSlider.oninput = () => {
      brushSize = Number(brushSlider.value);
      brushLabel.textContent = brushSize;
    };

    let mode = "spectate";

    function setMode(newMode) {
      mode = newMode;
      spectateBtn.classList.toggle("active", mode === "spectate");
      destroyBtn.classList.toggle("active", mode === "destroy");
      createBtn.classList.toggle("active", mode === "create");
    }

    spectateBtn.onclick = () => setMode("spectate");
    destroyBtn.onclick  = () => setMode("destroy");
    createBtn.onclick   = () => setMode("create");
    setMode("spectate");

    let mouseDown = false;

    function getCellFromEvent(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: Math.floor((e.clientX - rect.left) / terrain.tileSize),
        y: Math.floor((e.clientY - rect.top) / terrain.tileSize)
      };
    }

    function applyBrush(cx, cy) {
      for (let dy = -brushSize; dy <= brushSize; dy++) {
        for (let dx = -brushSize; dx <= brushSize; dx++) {
          const x = cx + dx;
          const y = cy + dy;

          if (!terrain.grid[y]?.[x]) continue;

          if (mode === "destroy") {
            terrain.digUp(y, x);
            terrain.digDown(y, x);
          }

          if (mode === "create") {
            terrain.grid[y][x][0] = true;
            terrain.grid[y][x][1] = true;
          }
        }
      }
    }

    function applyEdit(e) {
      if (!mouseDown || mode === "spectate") return;
      const { x, y } = getCellFromEvent(e);
      applyBrush(x, y);
    }

    canvas.addEventListener("mousedown", e => { mouseDown = true; applyEdit(e); });
    canvas.addEventListener("mousemove", applyEdit);
    window.addEventListener("mouseup", () => mouseDown = false);
    canvas.addEventListener("mouseleave", () => mouseDown = false);

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      sky.draw();
      terrain.draw();
      water.draw();
      requestAnimationFrame(gameLoop);
    }


    gameLoop();
  </script>

</body>
</html>
